# 2026-01-31 pgrokd 다중 터널 및 주소 변경 기능 고도화 작업 노트

## 1. 작업 배경 및 목적
기존 `pgrokd`는 사용자당 1개의 고정된 서브도메인과 토큰만 사용할 수 있는 제약이 있었음. 이를 개선하여 사용자 한 명이 여러 개의 독립된 터널을 생성/관리하고, 원하는 서브도메인으로 자유롭게 변경할 수 있는 기능을 구현함.

## 2. 주요 수정 사항

### 2.1 데이터베이스 구조 개편 (1:N 분리)
- **기존**: `principles` 테이블에 `token`, `subdomain`, `last_tcp_port`가 포함된 1:1 구조.
- **변경**: `tunnels` 테이블을 신설하여 터널링 정보를 독립시키고, `principles`와 1:N 관계를 맺음.
- **자동 마이그레이션**: 서버 시작 시 기존 `principles` 테이블의 레거시 데이터를 `tunnels` 테이블로 자동 이관하는 로직 구현.

### 2.2 SSH 서버 및 클라이언트 핸들러 수정
- **인증 방식 변경**: SSH PasswordCallback에서 토큰을 검증할 때 `tunnels` 테이블을 참조하여 어떤 터널 세션인지 식별하도록 수정.
- **다중 연결 지원**: 클라이언트마다 고유한 토큰을 사용하여 서로 다른 서브도메인으로 동시 접속 가능.

### 2.3 웹 관리 대시보드 및 API 구현
- **대시보드 UI**: React(Vite) 기반의 대시보드를 터널 목록 관리자 형태로 개편.
- **터널 제어**: 새 터널 생성, 기존 터널 삭제, 서브도메인 즉시 변경(PATCH) 기능 추가.
- **중복 처리**: 서브도메인 변경 시 이미 사용 중인 주소일 경우 `409 Conflict`와 함께 "Subdomain is already taken" 메시지를 반환하도록 예외 처리.

## 3. 빌드 및 배포 여정

### 3.1 크로스 컴파일 (Windows to Linux)
프론트엔드 빌드 후 리눅스용 바이너리를 생성함.
```powershell
# 프론트엔드 빌드
cd pgrokd/web
npm run build

# 리눅스용 Go 바이너리 빌드
cd ../../
$env:GOOS = "linux"
$env:GOARCH = "amd64"
go build -ldflags "-X main.version=v20260131" -o pgrokd-linux-amd64 ./pgrokd/cli
```

### 3.2 서버 바이너리 교체 및 권한 유지
기존 `/usr/local/bin/pgrokd`의 소유권과 권한을 복사하며 교체하는 스크립트 작성 및 실행.

- 이미 실행중이라면 종료.

```bash
netstat -tulnp | grep :3320
kill [PID]
```

- `stat`을 이용해 기존 파일의 UID/GID/Mode 추출 후 새 바이너리에 적용.

```bash
#!/bin/sh

# 1. 설정
TARGET="/usr/local/bin/pgrokd"
TEMP_FILE="/tmp/pgrokd_new"
DOWNLOAD_URL="https://github.com/ouor/pgrok/releases/download/v20260131/pgrokd-linux-amd64"

echo "--- pgrokd 업데이트 시작 ---"

# 2. 새 바이너리 다운로드 (curl 또는 wget 사용)
echo "신규 바이너리 다운로드 중..."
if command -v curl > /dev/null; then
    curl -L -o "$TEMP_FILE" "$DOWNLOAD_URL"
else
    wget -O "$TEMP_FILE" "$DOWNLOAD_URL"
fi

if [ $? -ne 0 ]; then
    echo "에러: 다운로드에 실패했습니다."
    exit 1
fi

# 3. 기존 파일 권한 및 소유권 복사
if [ -f "$TARGET" ]; then
    echo "기존 파일의 권한을 확인 중: $TARGET"
    
    # 기존 파일의 소유자(UID), 그룹(GID), 권한(Mode) 추출
    ORIG_UID=$(stat -c %u "$TARGET")
    ORIG_GID=$(stat -c %g "$TARGET")
    ORIG_MODE=$(stat -c %a "$TARGET")

    echo "기본 권한 적용: Owner($ORIG_UID), Group($ORIG_GID), Mode($ORIG_MODE)"
    
    # 새 파일에 적용
    chown "$ORIG_UID:$ORIG_GID" "$TEMP_FILE"
    chmod "$ORIG_MODE" "$TEMP_FILE"
else
    echo "기존 파일이 없어 기본 실행 권한(755)을 설정합니다."
    chmod 755 "$TEMP_FILE"
fi

# 4. 파일 교체
# 실행 중일 경우를 대비해 삭제 후 이동하거나, mv로 inode를 교체합니다.
echo "바이너리 교체 중..."
mv "$TEMP_FILE" "$TARGET"

echo "--- 업데이트 완료 ---"
ls -l "$TARGET"
```

### 3.3 데이터베이스 초기화
스키마 변경에 따른 기존 데이터 정리를 위해 `psql` 명령어로 테이블 초기화 수행.
```bash
psql -h localhost -U [사용자] -d pgrokd -c "DROP TABLE IF EXISTS tunnels, principles, host_keys, sessions CASCADE;"
```

## 4. 최종 결과
- 클라이언트(`pgrok` 앱) 수정 없이 서버 업데이트만으로 다중 터널링 지원.
- 사용자가 직접 주소를 변경하고 터널을 관리할 수 있는 셀프 서비스 환경 구축 완료.
