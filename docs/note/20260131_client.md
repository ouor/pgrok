# 2026-01-31 pgrok 클라이언트 다중 프로필 지원 및 설정 로직 개편 노트

## 1. 작업 배경 및 목적
기존 `pgrok` 클라이언트는 `pgrok.yml`에 단 하나의 설정(토큰, 주소 등)만 저장할 수 있는 제약이 있었음. 서버 측의 다중 터널 지원에 발맞추어, 클라이언트에서도 여러 개의 서버 주소나 토큰 정보를 프로필 형태로 관리하고 선택적으로 실행할 수 있는 기능을 구현함.

## 2. 주요 수정 사항

### 2.1 설정 구조체 개편 및 하위 호환성 확보
- **구조체 분리**: `http.go`에 포함되어 있던 설정 로직을 `pgrok/cli/config.go`로 독립시키고 `Profile`과 `Config` 구조체로 세분화함.
- **최상위 필드 유지**: 기존 사용자가 프로필 기능 없이 쓰던 설정을 그대로 읽을 수 있도록 YAML `inline` 태그를 활용하여 최상위 필드와 `profiles` 맵을 공존시킴.
- **Partial Update 지원**: 설정 파일 전면 교체 대신, 기존 내용을 로드하여 특정 프로필만 수정 후 저장하는 방식으로 안전하게 개편.

### 2.2 공통 플래그 및 프로필 적용 로직 (ApplyProfile)
- **전역 플래그 추가**: 모든 명령어(`init`, `http`, `tcp`)에서 `--profile` 옵션을 통해 대상 프로필을 지정할 수 있도록 수정.
- **투명한 데이터 매핑**: `ApplyProfile` 메서드를 도입하여, 실행 시점에 선택된 프로필의 값을 메인 설정 필드로 투명하게 덮어쓰도록 구현. 이를 통해 기존의 복잡한 네트워크 로직 수정 없이 다중 프로필 기능을 통합함.

### 2.3 `init` 명령어의 Upsert 방식 전환
- **기존**: 파일 전체를 템플릿으로 덮어쓰는 단순 생성 방식.
- **변경**: 기존 파일을 읽어 현재 입력된 프로필 정보만 추가하거나 수정하는 지능형 업데이트 방식으로 전환.

## 3. 빌드 및 배포 여정

### 3.1 윈도우 및 리눅스용 빌드
클라이언트가 다양한 운영체제에서 사용될 수 있도록 크로스 컴파일 명령어를 정립함.

```powershell
# 1. 윈도우용 빌드 (기본)
go build -o pgrok.exe ./pgrok/cli

# 2. 리눅스용 빌드 (AMD64 서버용)
$env:GOOS = "linux"
$env:GOARCH = "amd64"
go build -o pgrok-linux-amd64 ./pgrok/cli
```

### 3.2 하위 호환성 및 서버 연동 테스트
- **구버전 서버 호환**: 통신 프로토콜 수준의 변경 없이 설정 로직만 개선했으므로 기존 `pgrokd`와 제약 없이 통신 가능함을 확인.
- **설정 파일 마이그레이션**: 다중 프로필이 없는 기존 설정을 읽어 기본 접속을 시도하는 하위 호환성 동작 검증 완료.

## 4. 최종 결과
- 하나의 설정 파일로 여러 프로젝트와 서버 환경을 오가는 유연한 터널링 환경 구축.
- 기존 사용자의 학습 비용과 마이그레이션 부담을 최소화한 투명한 기능 고도화 완료.
- 명령행 인자(`8080` 등)가 설정 파일보다 우선순위를 갖는 기존의 편리한 사용성 유지.

## 5. 사용 예시 (Multi-Profile 활용)

### 5.1 프로필 등록
사용자의 작업 환경(Backend, Frontend)에 맞춰 개별 터널 설정을 저장합니다.
```powershell
# 1. Backend 프로필 등록 (8080 포트 기반)
pgrok init --profile backend --remote-addr example.com:2222 --forward-addr 8080 --token {BACKEND_TOKEN}

# 2. Frontend 프로필 등록 (Vite 5173 포트 기반)
pgrok init --profile frontend --remote-addr example.com:2222 --forward-addr 5173 --token {FRONTEND_TOKEN}

# 3. Blog 프로필 등록
pgrok init --profile blog --remote-addr example.com:2222 --forward-addr 3000 --token {BLOG_TOKEN}
```

### 5.2 프로필 기반 터널 실행
등록된 프로필 이름을 호출하여 독립적인 터널링 세션을 시작합니다.
```powershell
# Backend 터널 실행
pgrok http --profile backend

# Frontend 터널 실행
pgrok http --profile frontend

# Blog 터널 실행 (실행시 인자 포트가 우선 적용)
pgrok http --profile blog 9000
```
